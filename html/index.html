<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Chat</title>
  <meta name="description" content="Metacon Studios Chat">
  <meta name="author" content="Bogdan Radacina">
  
  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>
<body>
<div style="width:700px; height:500px">
	<div id="ChatUsers" style="width:200px;height:500px; float:right; overflow:auto"></div>
	<div id="ChatReceive" style="width:500px; height:500px; overflow:auto;"></div>
</div>
<input id="ChatInput" type="text" style="width:400px" />
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
	var wss;

	$(document).ready( function() {
		
		$("#ChatInput").keypress(sendMessage);
		
		wss = new WebSocket("ws://"+document.domain+":8081/chat?name=AAA");
		
		wss.onerror = function(status) {
			debugger;
			console.log(status);
		}
		
		wss.onclose = function(status) {
			debugger;
			$("#ChatReceive").prepend("<"+ now.toLocaleTimeString() + "> You have been disconnected<br/>");
		}
		
		wss.onmessage = function(status) {
			
			if (!status || !status.data )
			{
				return;
			}
			
			var msg;
			
			try{
			 	msg = JSON.parse(status.data);
			}
			catch(err) {
				return;
			}
			
			if (!msg) {
				return;
			}
			
			var now = new Date();
			
			if( msg.Type == "ServerChatMessage") {
				$("#ChatReceive").prepend("<"+ now.toLocaleTimeString() + "> "+ msg.Name + " said -> " + msg.Chat + "<br/>");
			}
			
			if(msg.Type == "ServerStatusMessage") {
				$("#ChatReceive").prepend("<"+ now.toLocaleTimeString() + "> "+msg.Content + "<br/>");
			}
			
			if(msg.Type == "ServerClientListMessage" ) {
				
			}
		}
	});
	
	function sendMessage(event) {
		if( event.charCode != 13)
		{
			return;
		}
		
		var msg = $("#ChatInput").val();
		$("#ChatInput").val("");
		
		var obj = new Object();
		obj.Type = "ClientChat";
		obj.Chat = msg;
				
		wss.send(JSON.stringify(obj));
	}
</script>

</body>
</html>
